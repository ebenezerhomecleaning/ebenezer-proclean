import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp } from 'firebase/firestore';
import { 
  Home, Building2, CheckCircle2, ShieldCheck, Smartphone, MessageCircle, AlertCircle, Lock, TrendingUp, Users, Calendar, ArrowRight
} from 'lucide-react';

// --- PRODUCTION CONFIGURATION ---
// Note: When moving to your own domain, replace these strings with your unique Firebase keys
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ebenezer-proclean-production';

export default function App() {
  // State Management
  const [user, setUser] = useState(null);
  const [view, setView] = useState('customer'); // 'customer' or 'staff'
  const [staffAuthenticated, setStaffAuthenticated] = useState(false);
  const [pin, setPin] = useState('');
  const [activeService, setActiveService] = useState('residential');
  const [bookings, setBookings] = useState([]);
  const [loading, setLoading] = useState(false);
  const [bookingConfirmed, setBookingConfirmed] = useState(null);

  // Business Configuration
  const BUSINESS_WHATSAPP = "971568540877";
  const STAFF_PIN = "2024"; 

  // Form State
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    hours: '2',
    cleaners: '1',
    sqm: '100',
    type: 'standard',
    addons: { deep: false, balcony: false, fridge: false, oven: false }
  });

  // 1. Initialize Authentication (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Real-time Database Listener (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort in memory to avoid needing complex Firebase indexes
      setBookings(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (error) => console.error("Database Sync Error:", error));
    return () => unsubscribe();
  }, [user]);

  // Pricing Engine
  const calculateTotal = () => {
    if (activeService === 'residential') {
      const base = { '1': { '2': 95, '4': 170, '8': 320 }, '2': { '2': 180, '4': 320, '8': 600 } };
      let total = base[formData.cleaners][formData.hours];
      if (formData.addons.deep) total += (80 * parseInt(formData.hours));
      if (formData.addons.balcony) total += 50;
      if (formData.addons.fridge) total += 40;
      if (formData.addons.oven) total += 40;
      return total;
    }
    const rate = formData.type === 'standard' ? 4 : 9;
    return rate * (parseInt(formData.sqm) || 0);
  };

  // Staff Authentication Logic
  const handleStaffLogin = (e) => {
    e.preventDefault();
    if (pin === STAFF_PIN) {
      setStaffAuthenticated(true);
    } else {
      setPin('');
      // In-app custom notification instead of alert()
      const feedback = document.getElementById('login-feedback');
      if (feedback) feedback.innerText = "Incorrect PIN. Try again.";
    }
  };

  // Submission Logic
  const submitBooking = async () => {
    if (!user || !formData.name || !formData.phone) return;
    setLoading(true);
    
    const bookingId = `EPC-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
    const total = calculateTotal();
    
    try {
      // Save to Firebase (Rule 1 Path)
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), {
        bookingId,
        customerName: formData.name,
        phone: formData.phone,
        service: activeService,
        total,
        status: 'Pending',
        details: activeService === 'residential' 
          ? `${formData.hours}h, ${formData.cleaners} cln` 
          : `${formData.sqm}sqm Office`,
        createdAt: serverTimestamp()
      });

      setBookingConfirmed(bookingId);
      
      // Professional WhatsApp Formatting
      const waMsg = `*EBENEZER PROCLEAN DUBAI*\n` +
                   `--------------------------\n` +
                   `ðŸ†” *Booking ID:* ${bookingId}\n` +
                   `ðŸ‘¤ *Customer:* ${formData.name}\n` +
                   `ðŸ“ž *Phone:* ${formData.phone}\n` +
                   `ðŸ’° *Total:* AED ${total}\n` +
                   `--------------------------\n` +
                   `_Please confirm my slot for cleaning._`;
      
      window.open(`https://wa.me/${BUSINESS_WHATSAPP}?text=${encodeURIComponent(waMsg)}`, '_blank');
      
      setTimeout(() => setBookingConfirmed(null), 8000);
    } catch (e) {
      console.error("Booking failed:", e);
    } finally {
      setLoading(false);
    }
  };

  const updateStatus = async (id, status) => {
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id);
    await updateDoc(docRef, { status });
  };

  // Analytics Helpers
  const revenue = bookings.reduce((sum, b) => sum + (Number(b.total) || 0), 0);

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-900 font-sans selection:bg-blue-100">
      {/* Premium Navigation */}
      <nav className="bg-white/80 backdrop-blur-md border-b px-6 py-4 flex items-center justify-between sticky top-0 z-[100]">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
            <ShieldCheck size={24} />
          </div>
          <div>
            <h1 className="text-lg font-black text-blue-900 leading-none">Ebenezer</h1>
            <p className="text-[9px] font-bold text-blue-500 uppercase tracking-[0.2em]">Dubai ProClean</p>
          </div>
        </div>
        <div className="flex bg-slate-100 p-1 rounded-xl border border-slate-200">
          <button 
            onClick={() => setView('customer')} 
            className={`px-5 py-2 rounded-lg text-xs font-black transition-all ${view === 'customer' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-800'}`}
          >
            BOOKING
          </button>
          <button 
            onClick={() => setView('staff')} 
            className={`px-5 py-2 rounded-lg text-xs font-black transition-all ${view === 'staff' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-800'}`}
          >
            STAFF
          </button>
        </div>
      </nav>

      <main className="max-w-5xl mx-auto p-6 md:py-12">
        {view === 'customer' ? (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-10 animate-in fade-in slide-in-from-bottom-4 duration-700">
            {/* Form Section */}
            <div className="lg:col-span-7 space-y-8">
              <header className="space-y-2">
                <h2 className="text-4xl font-black text-slate-900 tracking-tight">Professional Cleaning.</h2>
                <p className="text-slate-500 font-medium">Dubai's trusted service for homes and offices.</p>
              </header>

              <div className="bg-white rounded-[2.5rem] p-8 md:p-10 border border-slate-100 shadow-xl shadow-slate-200/50">
                <div className="flex p-1.5 bg-slate-50 rounded-2xl mb-10 border border-slate-100">
                  <button 
                    onClick={() => setActiveService('residential')} 
                    className={`flex-1 py-4 rounded-xl text-xs font-black flex items-center justify-center gap-2 transition ${activeService === 'residential' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}
                  >
                    <Home size={16} /> RESIDENTIAL
                  </button>
                  <button 
                    onClick={() => setActiveService('commercial')} 
                    className={`flex-1 py-4 rounded-xl text-xs font-black flex items-center justify-center gap-2 transition ${activeService === 'commercial' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}
                  >
                    <Building2 size={16} /> COMMERCIAL
                  </button>
                </div>

                <div className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Full Name</label>
                      <input 
                        className="w-full bg-slate-50 p-5 rounded-2xl outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-600 transition-all font-bold" 
                        placeholder="e.g. Salim Ahmed"
                        value={formData.name}
                        onChange={e => setFormData({...formData, name: e.target.value})}
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Phone Number</label>
                      <input 
                        className="w-full bg-slate-50 p-5 rounded-2xl outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-600 transition-all font-bold" 
                        placeholder="+971..."
                        value={formData.phone}
                        onChange={e => setFormData({...formData, phone: e.target.value})}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-6 pt-4">
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Service Length</label>
                      <select 
                        className="w-full bg-slate-50 p-5 rounded-2xl border-none ring-1 ring-slate-200 font-black outline-none appearance-none"
                        value={formData.hours}
                        onChange={e => setFormData({...formData, hours: e.target.value})}
                      >
                        <option value="2">2 Hours Visit</option>
                        <option value="4">4 Hours Visit</option>
                        <option value="8">Full Day (8h)</option>
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cleaners</label>
                      <select 
                        className="w-full bg-slate-50 p-5 rounded-2xl border-none ring-1 ring-slate-200 font-black outline-none appearance-none"
                        value={formData.cleaners}
                        onChange={e => setFormData({...formData, cleaners: e.target.value})}
                      >
                        <option value="1">1 Professional</option>
                        <option value="2">2 Professionals</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Price Card */}
            <div className="lg:col-span-5">
              <div className="sticky top-28 space-y-6">
                <div className="bg-slate-900 rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden group">
                  <div className="relative z-10">
                    <p className="text-blue-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">Total Estimate (Inc. VAT)</p>
                    <div className="flex items-baseline gap-3 mb-10">
                      <span className="text-7xl font-black tabular-nums transition-all group-hover:text-blue-400">{calculateTotal()}</span>
                      <span className="text-2xl font-bold text-slate-500">AED</span>
                    </div>

                    <div className="space-y-4 border-t border-slate-800 pt-8 mb-10 text-sm font-medium">
                      <div className="flex justify-between items-center text-slate-400">
                        <span>Verified Rates</span>
                        <span className="text-white font-bold text-xs uppercase bg-blue-600/20 px-2 py-1 rounded">Locked</span>
                      </div>
                      <div className="flex justify-between items-center text-slate-400">
                        <span>Transport</span>
                        <span className="text-green-400 font-black text-xs">FREE</span>
                      </div>
                    </div>

                    {bookingConfirmed ? (
                      <div className="bg-blue-600 p-6 rounded-3xl text-center space-y-1 animate-in zoom-in duration-300">
                        <CheckCircle2 size={32} className="mx-auto mb-2 text-white" />
                        <h4 className="text-lg font-black">Booking Saved!</h4>
                        <p className="text-[10px] font-bold text-blue-200 uppercase tracking-widest">Opening WhatsApp...</p>
                      </div>
                    ) : (
                      <button 
                        onClick={submitBooking} 
                        disabled={loading || !formData.name || !formData.phone}
                        className="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 py-6 rounded-3xl text-lg font-black shadow-xl shadow-blue-900/50 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                      >
                        {loading ? 'CONFIRMING...' : (
                          <>
                            CONFIRM VIA WHATSAPP <MessageCircle size={22} />
                          </>
                        )}
                      </button>
                    )}
                  </div>
                  <div className="absolute -bottom-20 -right-20 w-64 h-64 bg-blue-600/10 rounded-full blur-[80px]"></div>
                </div>

                <div className="bg-blue-50/50 border border-blue-100 p-6 rounded-[2rem] flex items-center gap-4">
                  <div className="bg-white p-3 rounded-2xl text-blue-600 shadow-sm border border-blue-50">
                    <Smartphone size={24} />
                  </div>
                  <div>
                    <h5 className="text-[10px] font-black text-blue-900 uppercase tracking-widest mb-1">Direct Support</h5>
                    <p className="text-sm font-black text-blue-700 tracking-tight">+971 56 854 0877</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          /* Staff Access View */
          !staffAuthenticated ? (
            <div className="max-w-sm mx-auto mt-20 p-10 bg-white rounded-[3rem] border border-slate-100 shadow-2xl text-center animate-in zoom-in duration-500">
              <div className="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center mx-auto mb-8 text-blue-600">
                <Lock size={40} />
              </div>
              <h3 className="text-2xl font-black mb-2 text-slate-900 tracking-tight">Staff Portal</h3>
              <p className="text-slate-400 text-sm mb-10 font-medium">Please enter your secure 4-digit PIN.</p>
              
              <form onSubmit={handleStaffLogin} className="space-y-6">
                <input 
                  type="password" 
                  placeholder="â€¢â€¢â€¢â€¢" 
                  className="w-full p-6 bg-slate-50 rounded-2xl text-center font-black text-3xl tracking-[0.6em] outline-none ring-2 ring-transparent focus:ring-blue-600 transition" 
                  value={pin} 
                  onChange={e => setPin(e.target.value)} 
                  autoFocus
                />
                <button className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl shadow-blue-100 transition hover:bg-blue-700 active:scale-95">
                  UNLOCK BOARD
                </button>
                <div id="login-feedback" className="text-red-500 text-[10px] font-black uppercase tracking-widest h-4"></div>
              </form>
            </div>
          ) : (
            /* Authenticated Staff Dashboard */
            <div className="space-y-10 animate-in fade-in duration-500">
              <header className="flex flex-col md:flex-row md:items-end justify-between gap-6">
                <div>
                  <h2 className="text-4xl font-black text-slate-900 tracking-tight">Business Intel</h2>
                  <p className="text-slate-500 font-medium">Performance summary for Ebenezer ProClean.</p>
                </div>
                <div className="flex gap-4">
                  <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col min-w-[140px]">
                    <TrendingUp className="text-green-500 mb-2" size={20} />
                    <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Total Revenue</span>
                    <span className="text-2xl font-black tabular-nums">AED {revenue}</span>
                  </div>
                  <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col min-w-[140px]">
                    <Users className="text-blue-500 mb-2" size={20} />
                    <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Client Count</span>
                    <span className="text-2xl font-black tabular-nums">{bookings.length}</span>
                  </div>
                </div>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {bookings.map(b => (
                  <div key={b.id} className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-lg hover:shadow-2xl transition-all group">
                    <div className="flex justify-between items-start mb-8">
                      <span className="bg-slate-100 px-3 py-1.5 rounded-xl text-[10px] font-black text-slate-500 border border-slate-100 tracking-wider">#{b.bookingId}</span>
                      <select 
                        value={b.status} 
                        onChange={(e) => updateStatus(b.id, e.target.value)}
                        className={`text-[9px] font-black uppercase tracking-widest py-2 px-3 rounded-xl border-none outline-none shadow-sm cursor-pointer transition ${
                          b.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
                        }`}
                      >
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </div>

                    <div className="mb-8">
                      <h4 className="text-2xl font-black text-slate-800 leading-tight mb-1">{b.customerName}</h4>
                      <p className="text-blue-600 font-black text-xs flex items-center gap-1.5">
                        <Smartphone size={14} /> {b.phone}
                      </p>
                    </div>

                    <div className="mt-auto pt-8 border-t border-slate-50 flex justify-between items-center">
                      <div>
                        <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Service</p>
                        <p className="text-sm font-bold text-slate-700">{b.details}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Quote</p>
                        <p className="text-xl font-black text-slate-900 tabular-nums">AED {b.total}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {bookings.length === 0 && (
                <div className="text-center py-40 bg-white rounded-[4rem] border-4 border-dashed border-slate-100">
                  <Calendar className="mx-auto text-slate-100 mb-6" size={80} />
                  <h4 className="text-2xl font-black text-slate-300">Quiet Day...</h4>
                  <p className="text-slate-400 font-medium">New bookings will appear here instantly.</p>
                </div>
              )}
            </div>
          )
        )}
      </main>
    </div>
  );
}